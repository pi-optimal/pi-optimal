# Reaching Impressions Goals for Facebook Campaigns

## Introduction

In the fast-paced world of digital advertising, platforms like Meta dominate, generating over $100 billion in revenue as of 2024 [1]. For marketing agencies—especially those serving mid-sized clients—navigating Meta’s advertising ecosystem poses unique challenges. Meeting specific campaign goals such as impressions within a constrained budget often requires continuous monitoring and adjustment, making the process resource-intensive and prone to error.

---

## Problem Statement


Unlike traditional advertising channels, where metrics such as impressions can be controlled directly, Meta’s platform relies on a performance-driven model influenced by budget allocation. Achieving specific goals—whether impressions or conversions—within budget constraints necessitates constant oversight. This manual process is labor-intensive and prone to inefficiencies.

`pi_optimal` addresses these challenges by leveraging reinforcement learning (RL) to automate and optimize advertising campaign management. Designed for data science teams—even those unfamiliar with advanced RL concepts — `pi_optimal` enables efficient control over campaigns to achieve consistent outcomes.

Our goal is twofold:
- Develop a model that optimally configures Facebook campaign settings to meet target impressions.
- Understand the model’s decision-making process to build trust in its predictions.

---

## Dataset

The dataset, provided by a mid-sized German marketing agency, consists of over 2,574 Facebook campaigns conducted between 2019 and 2022. Campaign data is aggregated daily, with the following key features:

### Dataset Features

- `campaign_id`: Unique identifier for each campaign
- `date`: Date of the data point
- `day_of_week`: Day of the week
- `impression_goal`: The target number of impressions for the campaign by the end of the runtime
- `daily_impressions`: The number of impressions generated by the campaign on that day
- `total_impressions`: The total number of impressions generated until that day
- `target_daily_impressions`: The target number of impressions for that day
- `target_total_impressions`: The target number of impressions until that day
- `missing_impressions`: The difference between the target and actual impressions for that day
- `total_days`: The total number of days the campaign has been running
- `remaining_days`: The number of days remaining for the campaign to run
- `set_cpm`: The cost per thousand impressions set for the campaign
- `feed_facebook_status`: Indicated if the campaign was run on the Facebook feed at that day
- `instant_article_facebook_status`: Indicated if the campaign was run on the Instant Article feed at that day
- `facebook_stories_facebook_status`: Indicated if the campaign was run on the Facebook Stories feed at that day
- `marketplace_facebook_status`: Indicated if the campaign was run on the Marketplace feed at that day
- `right_hand_column_facebook_status`: Indicated if the campaign was run on the Right Hand Column feed at that day

The dataset provides a comprehensive view of campaign performance, enabling us to train and evaluate our RL agent.

```python
import pandas as pd

df_historical_fb_camapigns = pd.read_csv('data/fb_history.csv', parse_dates=['date'])
df_historical_fb_camapigns.sort_values(['campaign_id', 'date'], inplace=True)
df_historical_fb_camapigns.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>campaign_id</th>
      <th>date</th>
      <th>day_of_week</th>
      <th>impression_goal</th>
      <th>daily_impressions</th>
      <th>total_impressions</th>
      <th>target_daily_impressions</th>
      <th>target_total_impressions</th>
      <th>missing_impressions</th>
      <th>total_days</th>
      <th>remaining_days</th>
      <th>set_cpm</th>
      <th>feed_facebook_status</th>
      <th>instant_article_facebook_status</th>
      <th>facebook_stories_facebook_status</th>
      <th>marketplace_facebook_status</th>
      <th>right_hand_column_facebook_status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2022-05-30</td>
      <td>Monday</td>
      <td>21000</td>
      <td>1244.0</td>
      <td>1244.0</td>
      <td>1400.0</td>
      <td>1400.0</td>
      <td>156.0</td>
      <td>15.0</td>
      <td>13.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Inactive</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>2022-06-01</td>
      <td>Wednesday</td>
      <td>21000</td>
      <td>915.0</td>
      <td>2159.0</td>
      <td>1400.0</td>
      <td>2800.0</td>
      <td>641.0</td>
      <td>15.0</td>
      <td>11.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Inactive</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>2022-06-08</td>
      <td>Wednesday</td>
      <td>21000</td>
      <td>5225.0</td>
      <td>7384.0</td>
      <td>1400.0</td>
      <td>4200.0</td>
      <td>-3184.0</td>
      <td>15.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>2022-06-09</td>
      <td>Thursday</td>
      <td>21000</td>
      <td>4402.0</td>
      <td>11786.0</td>
      <td>1400.0</td>
      <td>5600.0</td>
      <td>-6186.0</td>
      <td>15.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>2022-06-10</td>
      <td>Friday</td>
      <td>21000</td>
      <td>3202.0</td>
      <td>14988.0</td>
      <td>1400.0</td>
      <td>7000.0</td>
      <td>-7988.0</td>
      <td>15.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Uncomment the following lines for faster training and inference if you have sklearnex installed and are using an Intel CPU

import numpy as np
from sklearnex import patch_sklearn
patch_sklearn()
```

    Intel(R) Extension for Scikit-learn* enabled (https://github.com/intel/scikit-learn-intelex)



```python
# Add the root path to the sys path to load pi_optimal from the parent directory
import sys
sys.path.append("../..")
```

---

## Defining the Reward Function


To guide the RL model’s learning, we need to define a **reward function**. This function evaluates the quality of a given campaign state. The RL model then optimizes its decisions to maximize the reward.

In our case, the reward function minimizes the absolute difference between the target impressions and actual impressions (i.e., reducing over- or under-delivery). While our example reward function is straightforward, it can be extended to account for additional factors such as budget utilization or audience targeting.

### Implementation


```python
# Function to calculate reward
def calculate_reward(row, epsilon=1e-8):

    # Reward is the negative of the absolute difference between target and actual impressions
    reward = -abs(row.missing_impressions)
    
    return reward
```

### Apply the reward function to the dataset


```python
# Apply the reward calculation
df_historical_fb_camapigns['reward'] = df_historical_fb_camapigns.apply(calculate_reward, axis=1)
df_historical_fb_camapigns.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>campaign_id</th>
      <th>date</th>
      <th>day_of_week</th>
      <th>impression_goal</th>
      <th>daily_impressions</th>
      <th>total_impressions</th>
      <th>target_daily_impressions</th>
      <th>target_total_impressions</th>
      <th>missing_impressions</th>
      <th>total_days</th>
      <th>remaining_days</th>
      <th>set_cpm</th>
      <th>feed_facebook_status</th>
      <th>instant_article_facebook_status</th>
      <th>facebook_stories_facebook_status</th>
      <th>marketplace_facebook_status</th>
      <th>right_hand_column_facebook_status</th>
      <th>reward</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>2022-05-30</td>
      <td>Monday</td>
      <td>21000</td>
      <td>1244.0</td>
      <td>1244.0</td>
      <td>1400.0</td>
      <td>1400.0</td>
      <td>156.0</td>
      <td>15.0</td>
      <td>13.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Inactive</td>
      <td>-156.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>2022-06-01</td>
      <td>Wednesday</td>
      <td>21000</td>
      <td>915.0</td>
      <td>2159.0</td>
      <td>1400.0</td>
      <td>2800.0</td>
      <td>641.0</td>
      <td>15.0</td>
      <td>11.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Inactive</td>
      <td>-641.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>2022-06-08</td>
      <td>Wednesday</td>
      <td>21000</td>
      <td>5225.0</td>
      <td>7384.0</td>
      <td>1400.0</td>
      <td>4200.0</td>
      <td>-3184.0</td>
      <td>15.0</td>
      <td>4.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>-3184.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>2022-06-09</td>
      <td>Thursday</td>
      <td>21000</td>
      <td>4402.0</td>
      <td>11786.0</td>
      <td>1400.0</td>
      <td>5600.0</td>
      <td>-6186.0</td>
      <td>15.0</td>
      <td>3.0</td>
      <td>3.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>-6186.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>2022-06-10</td>
      <td>Friday</td>
      <td>21000</td>
      <td>3202.0</td>
      <td>14988.0</td>
      <td>1400.0</td>
      <td>7000.0</td>
      <td>-7988.0</td>
      <td>15.0</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>Active</td>
      <td>-7988.0</td>
    </tr>
  </tbody>
</table>
</div>



---

## Dataset Preparation
To train the RL agent, we prepare the dataset by specifying:

- **State columns**:  
   Variables describing the campaign’s current environment (e.g., `daily_impressions`, `day_of_week`, etc.).

- **Action columns**:  
   Variables representing the campaign settings that can be controlled (e.g., `set_cpm`, `feed_facebook_status`).

- **Reward Column**:  
    The reward function output, indicating the quality of a decision.

- **Unit and time columns**:  
   Identifiers for each campaign and the temporal sequence of data points.

## Example Configuration

```python
state_cols = [
    'daily_impressions', 'day_of_week', 'impression_goal',
    'total_impressions', 'target_daily_impressions', 'missing_impressions',
]

action_cols = [
    'set_cpm', 'feed_facebook_status', 'instant_article_facebook_status',
    'facebook_stories_facebook_status', 'marketplace_facebook_status', 'right_hand_column_facebook_status',
]

reward_col = 'reward'
timestamp_col = 'date'
unit_col = 'campaign_id'
```


### Configuration

Beides the columns mentioned above, we could also adjust the number of lookback timesteps for predicting how the campaign will evolve in the future. In our case we consider the last 7 days of data to make a decision. Now the dataset will be initialized, the features will be preprocessed and the dataset will be prepared for training.


```python
import pi_optimal as po

LOOKBACK_TIMESTEPS = 7
historical_dataset = po.datasets.timeseries_dataset.TimeseriesDataset(df=df_historical_fb_camapigns,
                                                                      state_columns=state_cols,
                                                                      action_columns=action_cols,
                                                                      reward_column=reward_col,
                                                                      timestep_column=timestamp_col,
                                                                      unit_index=unit_col,
                                                                      lookback_timesteps=LOOKBACK_TIMESTEPS)
```


<div id='logger-container'>
            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">⚙️</span>
                <span class="logger-message">Initializing new dataset...</span>
            </div>

            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #ffc107;">⚠️</span>
                <span class="logger-message">Timestep column 'date' is of datetime type. Converting to integer indices.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">📝</span>
                <span class="logger-message">Dataset has 38761 rows and 18 columns.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">📝</span>
                <span class="logger-message">Dataset has 2574 episodes.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">📝</span>
                <span class="logger-message">Dataset has 7 state features and 6 actions.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">⚙️</span>
                <span class="logger-message">Fitting feature processors...</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Processors created and fitted</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">⚙️</span>
                <span class="logger-message">Transforming features...</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'daily_impressions' using preprocessor 'StandardScaler() with mean 5062.49 and std 6334.49'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'day_of_week' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'impression_goal' using preprocessor 'StandardScaler() with mean 84559.33 and std 99238.31'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'total_impressions' using preprocessor 'StandardScaler() with mean 46247.71 and std 55739.09'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'target_daily_impressions' using preprocessor 'StandardScaler() with mean 4778.93 and std 5539.18'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'missing_impressions' using preprocessor 'StandardScaler() with mean -4196.24 and std 23362.99'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'reward' using preprocessor 'StandardScaler() with mean -12386.7 and std 20248.64'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'set_cpm' using preprocessor 'StandardScaler() with mean 2.24 and std 2.85'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'feed_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'instant_article_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'facebook_stories_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'marketplace_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'right_hand_column_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">✨</span>
                <span class="logger-message">Dataset was created successfully!</span>
            </div>
            </div>




<style>
    /* Logger Container */
    #logger-container {
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Segoe UI Emoji', 'Segoe UI Symbol', monospace;
        padding: 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-size: 1.0em; /* Increased font size */
        position: relative;
    }

    /* Individual Log Entry */
    .logger-entry {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        margin-bottom: 8px;
        background-color: #ffffff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-radius: 4px;
        transition: background-color 0.2s, box-shadow 0.2s;
        white-space: pre-wrap; /* Preserve whitespace for symbols */
        position: relative;
    }

    .logger-entry:hover {
        background-color: #f1f3f5;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Vertical Line Connector */
    .logger-entry::before {
        content: '';
        position: absolute;
        left: -20px; /* Adjust based on INDENT_STEP */
        top: 0;
        bottom: 0;
        width: 1px;
        background-color: #6c757d; /* Gray color for connectors */
        display: none; /* Hidden for top-level entries */
    }

    /* Display connector for indented entries */
    .logger-entry[data-indent="1"]::before,
    .logger-entry[data-indent="2"]::before,
    .logger-entry[data-indent="3"]::before,
    .logger-entry[data-indent="4"]::before,
    .logger-entry[data-indent="5"]::before {
        display: block;
    }

    /* Connector Line styling based on indent */
    .logger-entry[data-indent="1"]::before {
        left: 0;
    }
    .logger-entry[data-indent="2"]::before {
        left: 0;
    }
    /* Add more as needed for higher indent levels */

    /* Emoji */
    .logger-emoji {
        margin-right: 10px;
        font-size: 1em; /* Larger emoji size */
        flex-shrink: 0;
        color: inherit; /* Inherit color from parent */
    }

    /* Message */
    .logger-message {
        flex-grow: 1;
        color: #212529;
        word-break: break-word;
    }
</style>



## Agent Initialization and Training

Using `pi_optimal`, we initialize and train an RL agent to optimize campaign performance. Constraints are added to ensure feasible and cost-effective recommendations, such as limiting CPM values or activation of placements.

```python
from pi_optimal.agents.agent import Agent
import numpy as np

agent = Agent(dataset=historical_dataset,
                 type="mpc-continuous",
                 constraints= {
                        'min': np.array([0.1,  "Active", "Active", "Active", "Active", "Active"]),                       # Min values for: CPM, Feed, Instant Article, Stories, Marketplace, Right Hand Column
                        'max': np.array([9.0, "Inactive", "Inactive", "Inactive", "Inactive", "Inactive"])               # Max values for: CPM, Feed, Instant Article, Stories, Marketplace, Right Hand Column
                        },
                )


agent.train()
```


<div id='logger-container'>
            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">⚙️</span>
                <span class="logger-message">Creating agent of type mpc-continuous</span>
            </div>

            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">✨</span>
                <span class="logger-message">Agent of type mpc-continuous created.</span>
            </div>
            </div>




<style>
    /* Logger Container */
    #logger-container {
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Segoe UI Emoji', 'Segoe UI Symbol', monospace;
        padding: 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-size: 1.0em; /* Increased font size */
        position: relative;
    }

    /* Individual Log Entry */
    .logger-entry {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        margin-bottom: 8px;
        background-color: #ffffff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-radius: 4px;
        transition: background-color 0.2s, box-shadow 0.2s;
        white-space: pre-wrap; /* Preserve whitespace for symbols */
        position: relative;
    }

    .logger-entry:hover {
        background-color: #f1f3f5;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Vertical Line Connector */
    .logger-entry::before {
        content: '';
        position: absolute;
        left: -20px; /* Adjust based on INDENT_STEP */
        top: 0;
        bottom: 0;
        width: 1px;
        background-color: #6c757d; /* Gray color for connectors */
        display: none; /* Hidden for top-level entries */
    }

    /* Display connector for indented entries */
    .logger-entry[data-indent="1"]::before,
    .logger-entry[data-indent="2"]::before,
    .logger-entry[data-indent="3"]::before,
    .logger-entry[data-indent="4"]::before,
    .logger-entry[data-indent="5"]::before {
        display: block;
    }

    /* Connector Line styling based on indent */
    .logger-entry[data-indent="1"]::before {
        left: 0;
    }
    .logger-entry[data-indent="2"]::before {
        left: 0;
    }
    /* Add more as needed for higher indent levels */

    /* Emoji */
    .logger-emoji {
        margin-right: 10px;
        font-size: 1em; /* Larger emoji size */
        flex-shrink: 0;
        color: inherit; /* Inherit color from parent */
    }

    /* Message */
    .logger-message {
        flex-grow: 1;
        color: #212529;
        word-break: break-word;
    }
</style>




<div id='logger-container'>
            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">⚙️</span>
                <span class="logger-message">Training agent of type mpc-continuous</span>
            </div>

            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">✨</span>
                <span class="logger-message">The agent of type mpc-continuous has been trained.</span>
            </div>
            </div>




<style>
    /* Logger Container */
    #logger-container {
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Segoe UI Emoji', 'Segoe UI Symbol', monospace;
        padding: 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-size: 1.0em; /* Increased font size */
        position: relative;
    }

    /* Individual Log Entry */
    .logger-entry {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        margin-bottom: 8px;
        background-color: #ffffff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-radius: 4px;
        transition: background-color 0.2s, box-shadow 0.2s;
        white-space: pre-wrap; /* Preserve whitespace for symbols */
        position: relative;
    }

    .logger-entry:hover {
        background-color: #f1f3f5;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Vertical Line Connector */
    .logger-entry::before {
        content: '';
        position: absolute;
        left: -20px; /* Adjust based on INDENT_STEP */
        top: 0;
        bottom: 0;
        width: 1px;
        background-color: #6c757d; /* Gray color for connectors */
        display: none; /* Hidden for top-level entries */
    }

    /* Display connector for indented entries */
    .logger-entry[data-indent="1"]::before,
    .logger-entry[data-indent="2"]::before,
    .logger-entry[data-indent="3"]::before,
    .logger-entry[data-indent="4"]::before,
    .logger-entry[data-indent="5"]::before {
        display: block;
    }

    /* Connector Line styling based on indent */
    .logger-entry[data-indent="1"]::before {
        left: 0;
    }
    .logger-entry[data-indent="2"]::before {
        left: 0;
    }
    /* Add more as needed for higher indent levels */

    /* Emoji */
    .logger-emoji {
        margin-right: 10px;
        font-size: 1em; /* Larger emoji size */
        flex-shrink: 0;
        color: inherit; /* Inherit color from parent */
    }

    /* Message */
    .logger-message {
        flex-grow: 1;
        color: #212529;
        word-break: break-word;
    }
</style>



    100%|██████████| 7/7 [00:25<00:00,  3.68s/it]
    100%|██████████| 7/7 [00:26<00:00,  3.74s/it]


## Evaluation and Action Prediction

The trained RL agent is evaluated using unseen campaign data. For example, we select an underperforming campaign and analyze the agent’s recommendations for the last seven days.

## Key Steps:
1. Extract recent campaign data.
2. Create an inference dataset using the same configuration as the training set.
3. Use the agent to predict optimal actions.

### Load Current Data

We select here two campaigns which were not part of the training set. One campiagn is underperforming, so the agent should increase the CPM. The other campaign is overperforming, so the agent should decrease the CPM. We will start with the underperforming campaign.


```python
# Load the current adset control data

# df_current_adset_control = pd.read_csv('data/fb_current_over_deliver.csv', parse_dates=['date'])
df_current_adset_control = pd.read_csv('data/fb_current_under_deliver.csv', parse_dates=['date'])

# Apply the reward calculation
df_current_adset_control["reward"] = df_current_adset_control.apply(calculate_reward, axis=1)
```


```python
from util_plot import plot_campaign

plot_campaign(df_current_adset_control.copy())
```


    
![png](example_facebook_files/example_facebook_23_0.png)
    


### Create Current Dataset

For our dataset we would like what happen if we would let the agent make decisions for the last 7 days. After we cutout the last 7 days of the campaign we can now create a dataset for the agent to predict the optimal actions.


```python
df_current_adset_control = df_current_adset_control.iloc[:-7]

current_dataset = po.datasets.timeseries_dataset.TimeseriesDataset(df=df_current_adset_control,
                                                                    dataset_config=historical_dataset.dataset_config,
                                                                    lookback_timesteps=LOOKBACK_TIMESTEPS,
                                                                    train_processors=False,
                                                                    is_inference=True)
```


<div id='logger-container'>
            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">⚙️</span>
                <span class="logger-message">Initializing new dataset...</span>
            </div>

            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #ffc107;">⚠️</span>
                <span class="logger-message">Timestep column 'date' is of datetime type. Converting to integer indices.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">📝</span>
                <span class="logger-message">Dataset has 7 rows and 18 columns.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">📝</span>
                <span class="logger-message">Dataset has 1 episodes.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">📝</span>
                <span class="logger-message">Dataset has 7 state features and 6 actions.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">📝</span>
                <span class="logger-message">Using processors provided in the dataset_configuration.</span>
            </div>

            <div class="logger-entry" data-indent="1" style="margin-left: 20px;">
                <span class="logger-emoji" style="color: #0d6efd;">⚙️</span>
                <span class="logger-message">Transforming features...</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'daily_impressions' using preprocessor 'StandardScaler() with mean 5062.49 and std 6334.49'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'day_of_week' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'impression_goal' using preprocessor 'StandardScaler() with mean 84559.33 and std 99238.31'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'total_impressions' using preprocessor 'StandardScaler() with mean 46247.71 and std 55739.09'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'target_daily_impressions' using preprocessor 'StandardScaler() with mean 4778.93 and std 5539.18'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'missing_impressions' using preprocessor 'StandardScaler() with mean -4196.24 and std 23362.99'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed states feature 'reward' using preprocessor 'StandardScaler() with mean -12386.7 and std 20248.64'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'set_cpm' using preprocessor 'StandardScaler() with mean 2.24 and std 2.85'.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'feed_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'instant_article_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'facebook_stories_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'marketplace_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="2" style="margin-left: 40px;">
                <span class="logger-emoji" style="color: #0d6efd;">✅</span>
                <span class="logger-message">Transformed actions feature 'right_hand_column_facebook_status' using preprocessor 'OrdinalEncoder() '.</span>
            </div>

            <div class="logger-entry" data-indent="0" style="margin-left: 0px;">
                <span class="logger-emoji" style="color: #0d6efd;">✨</span>
                <span class="logger-message">Dataset was created successfully!</span>
            </div>
            </div>




<style>
    /* Logger Container */
    #logger-container {
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Segoe UI Emoji', 'Segoe UI Symbol', monospace;
        padding: 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        font-size: 1.0em; /* Increased font size */
        position: relative;
    }

    /* Individual Log Entry */
    .logger-entry {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        margin-bottom: 8px;
        background-color: #ffffff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border-radius: 4px;
        transition: background-color 0.2s, box-shadow 0.2s;
        white-space: pre-wrap; /* Preserve whitespace for symbols */
        position: relative;
    }

    .logger-entry:hover {
        background-color: #f1f3f5;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Vertical Line Connector */
    .logger-entry::before {
        content: '';
        position: absolute;
        left: -20px; /* Adjust based on INDENT_STEP */
        top: 0;
        bottom: 0;
        width: 1px;
        background-color: #6c757d; /* Gray color for connectors */
        display: none; /* Hidden for top-level entries */
    }

    /* Display connector for indented entries */
    .logger-entry[data-indent="1"]::before,
    .logger-entry[data-indent="2"]::before,
    .logger-entry[data-indent="3"]::before,
    .logger-entry[data-indent="4"]::before,
    .logger-entry[data-indent="5"]::before {
        display: block;
    }

    /* Connector Line styling based on indent */
    .logger-entry[data-indent="1"]::before {
        left: 0;
    }
    .logger-entry[data-indent="2"]::before {
        left: 0;
    }
    /* Add more as needed for higher indent levels */

    /* Emoji */
    .logger-emoji {
        margin-right: 10px;
        font-size: 1em; /* Larger emoji size */
        flex-shrink: 0;
        color: inherit; /* Inherit color from parent */
    }

    /* Message */
    .logger-message {
        flex-grow: 1;
        color: #212529;
        word-break: break-word;
    }
</style>



### Predict Optimal Actions


```python
best_actions = agent.predict(current_dataset)
```

    100%|██████████| 4/4 [00:00<00:00, 19.03it/s]


    Iteration: 1, Top-100 Cost: 0.1254 (Cost: 0.5874, Uncertainty: 0.4126)


    100%|██████████| 4/4 [00:00<00:00, 20.12it/s]


    Iteration: 2, Top-100 Cost: 0.1325 (Cost: 0.5761, Uncertainty: 0.4239)


    100%|██████████| 4/4 [00:00<00:00, 19.30it/s]


    Iteration: 3, Top-100 Cost: 0.1247 (Cost: 0.5877, Uncertainty: 0.4123)


    100%|██████████| 4/4 [00:00<00:00, 17.07it/s]


    Iteration: 4, Top-100 Cost: 0.1011 (Cost: 0.5227, Uncertainty: 0.4773)


    100%|██████████| 4/4 [00:00<00:00, 11.40it/s]


    Iteration: 5, Top-100 Cost: 0.0891 (Cost: 0.5441, Uncertainty: 0.4559)


    100%|██████████| 4/4 [00:00<00:00, 17.65it/s]


    Iteration: 6, Top-100 Cost: 0.0922 (Cost: 0.5691, Uncertainty: 0.4309)


    100%|██████████| 4/4 [00:00<00:00, 15.64it/s]


    Iteration: 7, Top-100 Cost: 0.085 (Cost: 0.6056, Uncertainty: 0.3944)


    100%|██████████| 4/4 [00:00<00:00, 18.09it/s]


    Iteration: 8, Top-100 Cost: 0.0947 (Cost: 0.5037, Uncertainty: 0.4963)


    100%|██████████| 4/4 [00:00<00:00, 16.28it/s]


    Iteration: 9, Top-100 Cost: 0.096 (Cost: 0.5896, Uncertainty: 0.4104)


    100%|██████████| 4/4 [00:00<00:00, 18.00it/s]

    Iteration: 10, Top-100 Cost: 0.0887 (Cost: 0.5694, Uncertainty: 0.4306)


    


---

## Interpreting the Results

The agent provides a sequence of optimal actions for the time horizon. Here we print them:


```python
for i in range(len(best_actions)):
    print(f"Timestep {i}:")
    print("Maximum CPM:", best_actions[i][0])
    print("Feed Facebook Status:", best_actions[i][1])
    print("Instant Article Facebook Status:", best_actions[i][2])
    print("Facebook Stories Facebook Status:", best_actions[i][3])
    print("Marketplace Facebook Status:", best_actions[i][4])
    print("Right Hand Column Facebook Status:", best_actions[i][5])
    print()
    print("--------------------")
    print()
```

    Timestep 0:
    Maximum CPM: 4.1440664897204105
    Feed Facebook Status: Inactive
    Instant Article Facebook Status: Inactive
    Facebook Stories Facebook Status: Active
    Marketplace Facebook Status: Inactive
    Right Hand Column Facebook Status: Active
    
    --------------------
    
    Timestep 1:
    Maximum CPM: 5.8248877751997234
    Feed Facebook Status: Inactive
    Instant Article Facebook Status: Inactive
    Facebook Stories Facebook Status: Active
    Marketplace Facebook Status: Active
    Right Hand Column Facebook Status: Active
    
    --------------------
    
    Timestep 2:
    Maximum CPM: 5.629406419293266
    Feed Facebook Status: Active
    Instant Article Facebook Status: Inactive
    Facebook Stories Facebook Status: Active
    Marketplace Facebook Status: Active
    Right Hand Column Facebook Status: Active
    
    --------------------
    
    Timestep 3:
    Maximum CPM: 7.144393154823279
    Feed Facebook Status: Inactive
    Instant Article Facebook Status: Active
    Facebook Stories Facebook Status: Inactive
    Marketplace Facebook Status: Inactive
    Right Hand Column Facebook Status: Active
    
    --------------------
    


--- 

## Visualization of Scenarios

`pi_optimal` provides visualization tools to analyze the agent’s recommendations. For instance, we can compare the agent’s suggested CPM values and placement statuses with actual performance, ensuring transparency and interpretability.

```python
from pi_optimal.utils.trajectory_visualizer import TrajectoryVisualizer

trajectory_visualizer = TrajectoryVisualizer(agent, current_dataset, best_actions=best_actions)
trajectory_visualizer.display()
```

image

---

## Conclusion

This notebook demonstrates how `pi_optimal` could be use to automate the control of facebook campaigns to reach a spesific impressions goal. Additional we have seen how we could use pi_optimal to run hypothestical scenarios. This could be used to understand how the agent would react to different settings or to understand how the agent would react to different scenarios.


### Key Highlights

- **Dataset Preparation**: 
   The dataset was prepared for training by defining the key parameters required for the RL agent. There is no need to manually preprocess the data, as the `pi_optimal` package streamlines this process.
- **Agent Training**: 
   The RL agent was trained on the dataset, learning to optimize the campaign settings to reach the desired impressions goal.
- **Action Prediction**:
    The agent predicted the optimal actions for two campaigns, one underperforming and one overperforming, to reach the desired impressions goal.
- **Simulation Visualization**:
    The results of the agent were visualized to understand how the agent would react to different scenarios.

---

## Next Steps

1. **Enhance Reward Function**: Use custom reward functions that incorporate additional features, such as budget constraints, audience targeting, or creative performance. By designing more complex reward functions, you can guide the agent to make decisions that align with broader campaign objectives.

2. **Hyperparameter Tuning**: Optimize the hyperparameters of the RL agent to improve its performance. By conducting a hyperparameter search, you can identify the optimal configuration that maximizes the agent's ability to reach the impressions goal.

3. **Real-Time Decision-Making**: Implement the agent in a real-time decision-making system to automate the optimization of Facebook campaigns. By integrating the agent into your existing ad management platform, you can leverage its capabilities to enhance campaign performance and efficiency.

# References

[1] https://investor.atmeta.com/home/
